<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment-with-locales.min.js" integrity="sha512-4F1cxYdMiAW98oomSLaygEwmCnIP38pb4Kx70yQYqRwLVCs3DbRumfBq82T08g/4LJ/
    smbFGFpmeFlQgoDccgg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <style>
        *{
            margin: 0;
            font-family: 'Pretendard';
        }
        body {
            background-color: gray;
            background-image: url(./image/background.png);
            background-size: 250%;
            padding: auto;
            padding-bottom: 100px;
            
        }
        /* 당일 날씨 섹션 */
        .weather-section {
            width: 400px;
            margin-left: auto;
            margin-right: auto;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 32px;
            box-sizing: border-box;
            text-align: center;
            color: #fff;
        }
        .city{
            position: relative;
            font-size: 16px;
            font-weight: 500;
            padding: 0;
        }
        .icon{
            width: 128px;
            height: 128px;
            position: relative;
            padding: 0;
        }
        .weather-status {
            margin: 0;
            padding: 0;
            position: relative;
            font-size: 64px;
            font-weight: 700;
        }
        #today_minmax{
            margin: 0;
            padding: 0;
            position: relative;
            font-size: 18px;
            font-weight: 500;
            
        }
        .min{
            display: inline-block;
            padding: 0 8px;
        }
        .max{
            display: inline-block;
            padding: 0 8px;
        }
        /* 시간별 날씨 */
        .hourly{
            position: relative;
            display: flex;
            margin-top: 32px;
            margin-left: auto;
            margin-right: auto;
            padding: 16px;
            gap: 16px;
            width: 400px;
            border-radius: 10px;
            background-color: rgba(0, 0, 0, 0.3);
            flex-wrap: nowrap;     
            overflow-x: auto;   
        }
        .hourly::-webkit-scrollbar {
            display: none;
        }
        .hourly-item{
            align-items: center;
            text-align: center;
        }
        .hourly-time{
            font-size: 14px;
            color: white;
        }
        .hourly-icon{
            width: 48px;
            height: 48px;
            opacity: 0.9;
        }
        .hourly-temp{
            font-size: 14px;
            color: white;
        }


        /* 미세먼지 */
        .air-quality{
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: center;
            margin-top: 32px;
            margin-left: auto;
            margin-right: auto;
            padding: 16px;
            width: 400px;
            border-radius: 10px;
            background-color: rgba(0, 0, 0, 0.3);
            color: white;
        }
        .air-quality-title{
            display: inline;
        }
        .air-quality h3{
            display: inline-block;
            text-align: left;
            margin-left: 16px;
            margin-right: 4px;
            font-size: 14px;
            font-weight: 400;
        }
        .pm10{
            display: inline-block;
            font-size: 12px;
            
        }
        .air-quality-text {
            text-align: left;
            margin-left: 16px;
            margin-right: 16px;
            font-size: 24px;
            font-weight: 600;
            margin-top: 8px;
        }
        .air-bar-container {
            margin-top: 8px;
            position: relative; 
            width: 370px;
            height: 8px;
            margin-left: 16px;
            margin-right: 16px;
            display: flex;
            align-items: center; 
        }
        .air-quality .air-color{
            width: 100%; 
            height: 100%;
            margin-left: 0;
        }
        .air-icon{
            position: absolute;
            top: 50%;
            left: 0%; 
            width: 8px;
            height: 8px;
            transform: translate(-50%, -50%); 
        }

        /* 주간예보 */
        .weekly{
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: center;
            margin-top: 32px;
            margin-left: auto;
            margin-right: auto;
            padding: 16px;
            width: 400px;
            border-radius: 10px;
            background-color: rgba(0, 0, 0, 0.3);
            color: white;
        }
        .weekly h3{
            text-align: left;
            margin-left: 16px;
            font-size: 14px;
            font-weight: 400;
        }
        .weekly-container {
            display: flex;
            flex-direction: column; 
            width: 100%;
            padding: 0 24px;
            box-sizing: border-box;
        }

        .weekly-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .weekly-item:last-child {
            border-bottom: none;
        }

        .weekly-day {
            font-size: 16px;
            font-weight: 500;
            flex-basis: 60px;
            text-align: left;
        }

        .weekly-icon {
            width: 24px; 
            height: 24px;
            opacity: 0.9;
        }

        .weekly-temp-min {
            font-size: 16px;
            font-weight: 400;
            flex-basis: 50px;
            text-align: right;
        }

        .weekly-temp-max {
            font-size: 16px;
            font-weight: 400;
            flex-basis: 50px;
            text-align: right;
        }

        /* 바텀시트 */
        .bottom{
            display: flex;
            flex-direction: column;
            position: fixed;
            box-sizing: border-box;
            width: 100%;
            height: 520px;
            bottom: -440px;
            background-color: white;
            color: black;
            border-top-left-radius: 45px;
            border-top-right-radius: 45px;
            text-align: center;
            align-items: center;
            font-size: 24px;
            transition: bottom 0.1s;
        }
        .bottom:not(.open):hover {
            bottom: -430px;
        }
        .handle{
            width: 100%;
            cursor: pointer; 
        }
        .open{
            bottom: 0;
        }
        .film{
            display: none;
            padding: 16px;
        }
        .logo{
            text-align: center;
            width: 150px;
            display: none;
        }
        .up-down{
            max-width: 24px;
        }
        .film-img{
            width: 200px;
            margin-top: 16px;
        }
        .film-name{
            font-size: 20px;
            font-weight: 600;
            margin-top: 16px;
        }
        .film-txt{
            font-size: 18px;
            margin-top: 8px;
            padding-left: 32px;
            padding-right: 32px;
        }
        .button{
            border: 0;
            outline: 0;
            background-color: #fff;
            cursor: pointer;

        }
        .film-img-section{
            align-items: center;
            display: flex;
            justify-content: center;

        }
        .film-button{
            justify-content: center;
            align-items: center;
            width: 32px;
            opacity: 0.7;
        }


    </style>
</head>
<!-- 바디 -->
<body>
<section class="weather-section">
    <div class="weather-info">
        <h1 class="city"></h1>
        <img class="icon" src>
        <h2 class="weather-status"></h2>
        <div class="today_minmax">
            <p class="min"></p>
            <p class="max"></p>
        </div>
    </div>
</section>

<!-- 시간별 날씨 -->
<div class="hourly">
</div>
<!-- 미세먼지 -->
<div class="air-quality">
    <div class="air-quality-title">
        <h3>미세먼지</h3>
        <p class="pm10">pm10</p>    
    </div>
    <p class="air-quality-text">--</p>
    <div class="air-bar-container">
        <img class="air-color" src="./icon/aircondition.png">
        <img class="air-icon" src="./icon/air-icon.png">
    </div>


</div>    

</div>
<!-- 주간예보 -->
<div class="weekly">
    <h3>주간예보</h3>
    <div class="weekly-container">
    </div>
    
</div>

<!-- 하단 트리거 (바텀시트 열기 버튼 역할) -->
<div class="bottom">
    <div class="handle" >
        <img class="up-down" src="./icon/up.png"><br>
        <p class="bottom-title" >오늘의 추천 필름을 확인하세요!</p>
        
        <img class="logo" src="./image/logo.png">
    </div>
    <div class="film">
        <div class="film-img-section">
            <button class="button"><img class="film-button" src="./icon/left.png"></button>
            <img class="film-img" src>
            <button class="button"><img class="film-button" src="./icon/right.png"></button>
        </div>
        <img class="example-img" src>
        <p class="film-name"></p>
        <p class="film-txt"></p>

    </div>

</div>


</body>


<!-- 스크립트 -->
<script>
// 시간에 따른 배경변환
let timeNow = moment().format("HH")
if ( 8 <= timeNow < 18 ){
    $('body').css('background-image', 'url(./image/background.png)')
} else {
    $('body').css('background-image', 'url(./image/background-night.png)')
}



//현재날씨
let url = 'https://api.openweathermap.org/data/2.5/weather?lat=37.340834&lon=126.733897&appid=cad522b3f4cc6f371dd04ea0b6286e33&units=metric'

$.getJSON(url, function(data){

    let city = data.name
    let temp = data.main.temp
    let temp_max = data.main.temp_max
    let temp_min = data.main.temp_min
    let icon = getWeatherIcon(data.weather[0].icon)
    
    $('.icon').attr('src', './icon/' + icon + '.png')
    $('.weather-status').text(parseInt(Number(temp)) + '℃')
    $('.max').text('최고: ' + parseInt(Number(temp_max)) + '℃')
    $('.min').text('최저: ' + parseInt(Number(temp_min)) + '℃')
    
    let hourlyNow= `
        <div class="hourly-item">
            <p class="hourly-time">현재</p>
            <img class="hourly-icon" src="./icon/${icon}.png">
            <p class="hourly-temp">${parseInt(Number(temp))}℃</p>
        </div>
        `
    $('.hourly').append(hourlyNow)

    // 필름 추천 json 데이터 가져오기
    $.getJSON('film.json', function(film) {
        // 아이콘으로 데이터 가져오기 filmData에 정보 저장
        let filmData = film[icon];
        // filmData에 해당 날씨 정보가 있는지 확인
        if (filmData) {
            $('.film-name').text(filmData.filmName)
            $('.film-txt').text(filmData.reason)
            $('.film-img').attr('src', filmData.image)

        } else {
            $('.film-name').text('추천 필름 정보를 불러올 수 없습니다.')
            $('.film-txt').text('날씨 코드를 확인해주세요.')
        }
    })  
    
    //한글 도시명으로 변환
    let urlC = `http://api.openweathermap.org/geo/1.0/direct?q=${city}&limit=5&appid=cad522b3f4cc6f371dd04ea0b6286e33`

    $.getJSON(urlC, function(cityData){
        let korean = cityData[0].local_names.ko
        $('.city').text(korean)
    })
    
    // //주간날씨 css 테스트
    // let weeklyTody= `
    //     <div class="weekly-item">
    //     <span class="weekly-day">오늘</span>
    //     <img class="weekly-icon" src="./icon/${icon}.png">
    //     <span class="weekly-temp-min">${parseInt(temp_min)}℃</span>
    //     <span class="weekly-temp-max">${parseInt(temp_max)}℃</span>
    //     </div>
    // `;
    // $('.weekly-container').append(weeklyTody)
})



//시간대별 날씨
let urlH = 'https://api.openweathermap.org/data/2.5/forecast/hourly?lat=37.340834&lon=126.733897&appid=cad522b3f4cc6f371dd04ea0b6286e33&units=metric&cnt=24'

$.getJSON(urlH, function(data){

    let hourlyData = data.list

    $.each(hourlyData, function(index, item){
        
        let hour = moment(item.dt * 1000).format('HH')
        let temp = parseInt(Number(item.main.temp)) + '℃'
        let icon = getWeatherIcon(item.weather[0].icon)
        
        let hourlyWeahter = `
        <div class="hourly-item">
            <p class="hourly-time">${hour}시</p>
            <img class="hourly-icon" src="./icon/${icon}.png">
            <p class="hourly-temp">${temp}</p>
        </div>
        `
        $('.hourly').append(hourlyWeahter)
    })
})

// 미세먼지
let urlA = 'https://api.openweathermap.org/data/2.5/air_pollution?lat=37.340834&lon=126.733897&appid=cad522b3f4cc6f371dd04ea0b6286e33'

$.getJSON(urlA, function(data){

    let pm10 = data.list[0].components.pm10; 
    let airQuality = getAirQualityStatus(pm10);

    $('.air-quality-text').text(parseInt(airQuality[1]) + ' ' + airQuality[0]);
    $('.air-icon').css('left', airQuality[2] + '%');
});

//주간날씨
let urlW = 'https://api.openweathermap.org/data/2.5/forecast/daily?lat=37.340834&lon=126.733897&appid=cad522b3f4cc6f371dd04ea0b6286e33&units=metric'

$.getJSON(urlW, function(data){
    for ( i = 0; i<7; i++){

        let temp_min = data.list[i].temp.min
        let temp_max = data.list[i].temp.max
        let icon = getWeatherIcon(data.list[i].weather[0].icon)
        
        let weeklyWeather= `
            <div class="weekly-item">
            <span class="weekly-day">${getDay(i)}</span> 
            <img class="weekly-icon" src="./icon/${icon}.png">
            <span class="weekly-temp-min">${parseInt(temp_min)}℃</span>
            <span class="weekly-temp-max">${parseInt(temp_max)}℃</span>
            </div>
        `;
        
        $('.weekly-container').append(weeklyWeather)
    }
    
})

//바텀시트 열기/닫기
$('.handle').click(function(){
    // 닫힘
if ($('.bottom').hasClass('open')){
        $('.bottom').toggleClass('open').animate({ bottom: '-440px' }, 500, function() {
            $('.bottom').css('bottom', '')
        })
        $('.up-down').attr('src', './icon/up.png')
        $('.logo').hide(500)
        $('.film').hide()
        $('.bottom-title').show(500)
        
    } else{ // 열림
        $('.bottom').toggleClass('open').animate({ bottom: '0px' }, 500, function() {
            $('.bottom').css('bottom', '')
        });
        $('.up-down').attr('src', './icon/down.png')
        $('.bottom-title').hide(500)
        $('.logo').show(500)
        $('.film').show(500)
    }
})

//버튼 누를때마다 사진 바꾸기
$('.button').click(function(){
    i = (i+1)%3
    if (i == 0){
        $('.film-img').attr('src','./image/example/sun1.png')
    } else if ( i == 1){
        $('.film-img').attr('src','./image/film/sun.png')
    } else if ( i == 2){
        $('.film-img').attr('src','./image/example/sun.png')
    }
})

function getWeatherIcon(weatherIcon){
    let icon;
    switch (weatherIcon){
    case '01d':
        icon = 'sun';
        break;
    case '01n':
        icon = 'moon';
        break;
    case '02d':
        icon = 'sun-cloud'
        break;
    case '02n':
        icon = 'moon-cloud';
        break;
    case '03d':
    case '03n':
    case '04d':
    case '04n':
        icon = 'cloud';
        break;
    case '09d':
    case '09n':
    case '10d':
    case '10n':
        icon = 'rain';
        break;
    case '11d':
    case '11n':
        icon = 'storm';
        break;
    case '13d':
    case '13n':
        icon = 'snow';
        break;
    case '50d':
    case '50n':
        icon = 'dust';
        break;
    default:
        icon = '알 수 없음';
    }
    return icon;
}

// PM10 수치 인디케이터 퍼센트 변환
function getAirQualityStatus(pm10) {
    let status = '';
    let percent = 0;
    let maxPm10 = 200;
    // 환경부 기준
    // 좋음 (0-30), 보통 (31-80), 나쁨 (81-150), 매우 나쁨 (151이상)
    if (pm10 <= 30){
        status = '좋음';
    } else if (pm10 <= 80){
        status = '보통';
    } else if (pm10 <= 150){
        status = '나쁨';
    } else {
        status = '매우 나쁨';
    }
    //100퍼 보다 높으면 100으로
    //0보다 낮으면 0으로
    percent = (pm10 / maxPm10) * 100;
    if (percent > 100){
        percent = 100;
    } else if (percent < 0){
        percent = 0;
    }

    return [status,pm10,percent];
}


//예보 오늘 내일 모레 며칠 후 인지 가져오는 함수
function getDay(i){
    let day = ''
    if (i == 0){
        day = '오늘'
    } else if (i == 1) {
        day = '내일'
    } else if (i == 2) {
        day = '모레'
    } else {
        day = `${i}일 후`
    }
    return day
}
</script>
</html>
